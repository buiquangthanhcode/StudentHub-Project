name: Shorebird Android

on:
  push:
    branches:
      - realease/*

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

jobs:
  shorebird_android:
    defaults: 
      run:
        shell: bash

    runs-on: ubuntu-latest

    steps:
      - name: 📚 Git Checkout
        uses: actions/checkout@v3

      - name: 🐦 Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        
      - name: 🚀 Shorebird Release
        if: ${{ github.event.created }}
        run: |
          shorebird release android --flutter-version=3.19.6 | tee output.log
          GREP_MATCH=$(grep -Ei "Published Release (.*)" output.log)
          if [[ $GREP_MATCH ]]; then
            # Strip the non-version-number characters from the line
            RELEASE_VERSION=$(echo $GREP_MATCH | sed -E 's/^.+ Published Release (.*)\!$/\1/')
            echo "release-version=$(echo $RELEASE_VERSION)" >> $GITHUB_OUTPUT
          else
            echo "Failed to create release"
            exit 1
          fi

      - name: 🚀 Shorebird Patch
        if: ${{ !github.event.created }}
        run: |
          shorebird patch android | tee output.log
          GREP_MATCH=$(grep -Ei "Published Patch (.*)" output.log)
          if [[ $GREP_MATCH ]]; then
            # Strip the non-version-number characters from the line
            PATCH_NUMBER=$(echo $GREP_MATCH | sed -E 's/^.+ Published Patch (.*)\!$/\1/')
            echo "patch-number=$(echo $PATCH_NUMBER)" >> $GITHUB_OUTPUT
          else
            echo "Failed to create patch"
            exit 1
          fi