name: Shorebird Android

on:
  push:
    branches:
      - realease/*

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

jobs:
  shorebird_android:
    defaults: 
      run:
        shell: bash

    runs-on: ubuntu-latest

    steps:
      - name: 📚 Git Checkout
        uses: actions/checkout@v3

      - name: 🐦 Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        
      - name: 🚀 Shorebird Release
        if: ${{ github.event.created }}
        uses: shorebirdtech/shorebird-release@v0
        with:
          platform: android

      - name: 🚀 Shorebird Patch
        if: ${{ !github.event.created }}
        run: |
          shorebird patch android --release-version=1.2.3+4 | tee output.log
          GREP_MATCH=$(grep -Ei "Published Patch (.*)" output.log)
          if [[ $GREP_MATCH ]]; then
            # Strip the non-version-number characters from the line
            PATCH_NUMBER=$(echo $GREP_MATCH | sed -E 's/^.+ Published Patch (.*)\!$/\1/')
            echo "patch-number=$(echo $PATCH_NUMBER)" >> $GITHUB_OUTPUT
          else
            echo "Failed to create patch"
            exit 1
          fi